{% extends "base.html" %}

{% block content %}
<div class="container" style="margin-top: 100px;">
    <!-- Header with Back Button -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
        </div>
        <h2>Computer Control</h2>
        <div>
            <select id="labSelect" class="form-select" style="width: 200px;">
                <option value="">Select Lab</option>
            </select>
        </div>
    </div>

    <!-- Computer Grid -->
    <div class="card custom-card">
        <div class="card-header">
            <h5 class="card-title mb-0">Computer Status</h5>
        </div>
        <div class="card-body">
            <div id="computerGrid" class="row g-4">
                <!-- Computers will be dynamically added here -->
            </div>
        </div>
    </div>
</div>

<style>
.computer-card {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    text-align: center;
    transition: all 0.3s ease;
}

.computer-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.computer-status {
    font-size: 0.9rem;
    margin-top: 10px;
}

.status-vacant {
    color: #28a745;
}

.status-occupied {
    color: #dc3545;
}

.computer-icon {
    font-size: 2rem;
    margin-bottom: 10px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadLabs();
    
    // Add event listener for lab selection
    document.getElementById('labSelect').addEventListener('change', function() {
        const selectedLab = this.value;
        if (selectedLab) {
            loadComputers(selectedLab);
        } else {
            document.getElementById('computerGrid').innerHTML = '';
        }
    });
});

function loadLabs() {
    fetch('/get_labs')
        .then(response => response.json())
        .then(data => {
            const labSelect = document.getElementById('labSelect');
            if (data.labs && Array.isArray(data.labs)) {
                data.labs.forEach(lab => {
                    const option = document.createElement('option');
                    option.value = lab.roomNumber;
                    option.textContent = `Lab ${lab.roomNumber} (Capacity: ${lab.capacity})`;
                    labSelect.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('Error loading labs:', error);
            alert('Error loading labs');
        });
}

function loadComputers(labNumber) {
    fetch(`/get_computers/${labNumber}`)
        .then(response => response.json())
        .then(data => {
            const computerGrid = document.getElementById('computerGrid');
            computerGrid.innerHTML = '';
            
            if (data.computers && Array.isArray(data.computers)) {
                data.computers.forEach(computer => {
                    const col = document.createElement('div');
                    col.className = 'col-md-3 col-sm-6';
                    
                    const statusClass = computer.status === 'vacant' ? 'status-vacant' : 'status-occupied';
                    const buttonClass = computer.status === 'vacant' ? 'btn-success' : 'btn-danger';
                    
                    col.innerHTML = `
                        <div class="computer-card">
                            <div class="computer-icon">
                                <i class="fas fa-desktop"></i>
                            </div>
                            <h5>PC ${computer.number}</h5>
                            <div class="computer-status ${statusClass}">
                                Status: ${computer.status.toUpperCase()}
                            </div>
                            <button onclick="toggleComputerStatus('${labNumber}', ${computer.number})" 
                                    class="btn ${buttonClass} mt-3">
                                Change Status
                            </button>
                        </div>
                    `;
                    
                    computerGrid.appendChild(col);
                });
            }
        })
        .catch(error => {
            console.error('Error loading computers:', error);
            alert('Error loading computers');
        });
}

function toggleComputerStatus(labNumber, computerNumber) {
    fetch('/toggle_computer_status', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            lab_number: labNumber,
            computer_number: computerNumber
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadComputers(labNumber); // Reload the computers to show updated status
        } else {
            alert('Error: ' + (data.error || 'Failed to update computer status'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating computer status');
    });
}
</script>
{% endblock %} 